{% extends "base.html" %}
{% load static %}

{% block title %}–í—Ö–æ–¥ ‚Äî Paragraph{% endblock %}

{% block extra_css %}
<link href="{% static 'css/login.css' %}" rel="stylesheet">
{% endblock %}

{% block footer %}
<!-- –§—É—Ç–µ—Ä —Å–∫—Ä—ã—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞ -->
{% endblock %}

{% block content %}

<div class="login-page-container d-flex align-items-center justify-content-center min-vh-100">
    <div class="login-content text-center">
        <div class="mb-5">
            <h1 class="display-4 mb-4">–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
            <p class="lead text-muted">
                –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://t.me/paragraph_uzbot" target="_blank" rel="noopener"
                    class="text-decoration-underline">@paragraph_uzbot</a>
                Telegram –±–æ—Ç –∏ –ø–æ–ª—É—á–∏—Ç–µ –≤–∞—à –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞.
            </p>
        </div>

        <form id="code-form" class="mb-4">
            <div class="code-container">
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–ü–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="0">
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–í—Ç–æ—Ä–∞—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="1" disabled>
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–¢—Ä–µ—Ç—å—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="2" disabled>
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–ß–µ—Ç–≤–µ—Ä—Ç–∞—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="3" disabled>
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–ü—è—Ç–∞—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="4" disabled>
                <input type="text" class="form-control code-input" maxlength="1" pattern="[0-9]" title="" placeholder=""
                    required aria-label="–®–µ—Å—Ç–∞—è —Ü–∏—Ñ—Ä–∞ –∫–æ–¥–∞" data-index="5" disabled>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-magic me-1"></i>
                    –í–≤–µ–¥–∏—Ç–µ –≤—Å–µ 6 —Ü–∏—Ñ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞
                </small>
                <div class="mt-2">
                    <div class="spinner-border spinner-border-sm text-primary d-none" id="loading-spinner"
                        role="status">
                        <span class="visually-hidden">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span>
                    </div>
                </div>
            </div>
        </form>

        <div class="alert d-none" id="alert-box"></div>

    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('.code-input');
        const form = document.getElementById('code-form');
        const alertBox = document.getElementById('alert-box');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        function updateFieldStates() {
            inputs.forEach((input, index) => {
                if (index === 0) {
                    input.disabled = false;
                } else {
                    input.disabled = !inputs[index - 1].value;
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –º–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å —Ü–∏—Ñ—Ä—É –∏–∑ –ø–æ–ª—è
        function canDeleteFromField(index) {
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª–µ –∏–ª–∏ —Å–ø—Ä–∞–≤–∞ –Ω–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
            for (let i = index + 1; i < inputs.length; i++) {
                if (inputs[i].value) {
                    return false; // –°–ø—Ä–∞–≤–∞ –µ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                }
            }
            return true; // –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        inputs.forEach((input, index) => {
            input.addEventListener('input', function (e) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã 0-9
                if (e.target.value && !/^[0-9]$/.test(e.target.value)) {
                    e.target.value = '';
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Ü–∏—Ñ—Ä—ã
                if (e.target.value) {
                    setTimeout(() => {
                        e.target.setSelectionRange(1, 1);
                    }, 0);
                }

                if (e.target.value && index < inputs.length - 1) {
                    inputs[index + 1].disabled = false;
                    inputs[index + 1].focus();
                }
                updateFieldStates();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –≤—Å–µ –ø–æ–ª—è
                const allFilled = Array.from(inputs).every(input => input.value);
                if (allFilled) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                    setTimeout(() => {
                        submitForm();
                    }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
                }
            });

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            input.addEventListener('keypress', function (e) {
                if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) {
                    e.preventDefault();
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
            input.addEventListener('paste', function (e) {
                e.preventDefault();
                const pastedData = (e.clipboardData || window.clipboardData).getData('text');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –∏—Ö —Ä–æ–≤–Ω–æ 6
                if (/^[0-9]{6}$/.test(pastedData)) {
                    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –ø–æ –ø–æ–ª—è–º
                    const digits = pastedData.split('');
                    inputs.forEach((field, index) => {
                        if (index < digits.length) {
                            field.value = digits[index];
                        }
                    });

                    // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                    inputs.forEach(field => field.disabled = false);
                    inputs[inputs.length - 1].focus();
                    inputs[inputs.length - 1].setSelectionRange(1, 1);

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
                    setTimeout(() => {
                        submitForm();
                    }, 300);
                } else {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    alertBox.className = 'alert alert-warning';
                    alertBox.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Ä–æ–≤–Ω–æ 6 —Ü–∏—Ñ—Ä';
                    alertBox.classList.remove('d-none');
                    setTimeout(() => {
                        alertBox.classList.add('d-none');
                    }, 3000);
                }
            });

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace') {
                    if (!e.target.value && index > 0) {
                        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É
                        input.disabled = true;
                        inputs[index - 1].focus();
                        updateFieldStates();
                    } else if (e.target.value && !canDeleteFromField(index)) {
                        // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å —Ü–∏—Ñ—Ä–∞, –Ω–æ —Å–ø—Ä–∞–≤–∞ –µ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è - –±–ª–æ–∫–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                        e.preventDefault();
                        return false;
                    }
                }
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–º –ø–æ–ª–µ
            input.addEventListener('focus', function (e) {
                if (e.target.value) {
                    setTimeout(() => {
                        e.target.setSelectionRange(1, 1);
                    }, 0);
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function submitForm() {
            const code = Array.from(inputs).map(input => input.value).join('');
            if (code.length !== 6) {
                alertBox.className = 'alert alert-danger';
                alertBox.textContent = '–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ 6 —Ü–∏—Ñ—Ä –∫–æ–¥–∞';
                alertBox.classList.remove('d-none');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è
            const spinner = document.getElementById('loading-spinner');
            spinner.classList.remove('d-none');
            inputs.forEach(input => input.disabled = true);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            alertBox.className = 'alert alert-info';
            alertBox.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥...';
            alertBox.classList.remove('d-none');

            try {
                console.log('üîç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥:', code);

                const resp = await fetch('/users/auth/verify_code/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `code=${code}`
                });
                const data = await resp.json();

                console.log('üìä –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                if (data.ok) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    alertBox.className = 'alert alert-success';
                    alertBox.innerHTML = '<i class="bi bi-check-circle me-2"></i>–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç...';
                    alertBox.classList.remove('d-none');

                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 1500);
                } else {
                    alertBox.className = 'alert alert-danger';
                    let errorMessage = `<i class="bi bi-exclamation-triangle me-2"></i>–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'}`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                    if (data.error === 'code_expired') {
                        errorMessage = '<i class="bi bi-clock me-2"></i>–í—Ä–µ–º—è –∫–æ–¥–∞ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –≤ –±–æ—Ç–µ.';
                    } else if (data.error === 'invalid_code') {
                        errorMessage = '<i class="bi bi-exclamation-triangle me-2"></i>–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.';
                    } else if (data.error === 'database_error') {
                        errorMessage = '<i class="bi bi-exclamation-triangle me-2"></i>–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    }

                    alertBox.innerHTML = errorMessage;
                    alertBox.classList.remove('d-none');

                    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    inputs.forEach(input => input.value = '');
                    updateFieldStates();
                    inputs[0].focus();
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', e);
                alertBox.className = 'alert alert-danger';
                alertBox.innerHTML = '<i class="bi bi-wifi-off me-2"></i>–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
                alertBox.classList.remove('d-none');
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è
                spinner.classList.add('d-none');
                inputs.forEach(input => input.disabled = false);
                updateFieldStates();
            }
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            submitForm();
        });

        // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        inputs[0].focus();
    });
</script>
{% endblock %}
{% endblock %}