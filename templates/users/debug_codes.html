{% extends "base.html" %}
{% load static %}

{% block title %}Отладка кодов — Paragraph{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/debug_codes.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-bug text-warning me-2"></i>
                Отладка OTP кодов
            </h1>

            {% if error %}
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>Ошибка базы данных</h5>
                <p class="mb-0"><strong>Ошибка:</strong> {{ error }}</p>
                <small class="text-muted">Возможно, проблема с подключением к MongoDB или структурой данных.</small>
            </div>
            {% endif %}

            <!-- Статистика -->
            <div class="row mb-4 align-items-stretch">
                <div class="col-md-3">
                    <div class="card border-success h-100">
                        <div class="card-body text-center">
                            <h5 class="text-success">{{ active_count }}</h5>
                            <small>Активных кодов</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info h-100">
                        <div class="card-body text-center">
                            <h5 class="text-info">{{ total_count }}</h5>
                            <small>Всего сессий</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-secondary h-100">
                        <div class="card-body">
                            <small class="text-muted">Текущее время:</small>
                            <div class="fw-bold" id="currentTime">{{ current_time|date:"d.m.Y H:i:s" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Активные коды -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Активные коды ({{ active_count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_sessions %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Код</th>
                                    <th>Пользователь</th>
                                    <th>Создан</th>
                                    <th>Истекает</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in active_sessions %}
                                <tr>
                                    <td><code>{{ session.id }}</code></td>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ session.code }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ session.user.username }}</strong>
                                        <br><small class="text-muted">ID: {{ session.user.id }}</small>
                                    </td>
                                    <td>{{ session.created_at|date:"H:i:s" }}</td>
                                    <td>
                                        {{ session.expires_at|date:"H:i:s" }}
                                        <br><small class="text-muted">
                                            {% if session.expires_at > current_time %}
                                            <span class="text-success">Активен</span>
                                            {% else %}
                                            <span class="text-danger">Истек</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        <p>Нет активных кодов</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Все сессии -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list me-2"></i>
                        Последние сессии ({{ total_count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if all_sessions %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Код</th>
                                    <th>Пользователь</th>
                                    <th>Статус</th>
                                    <th>Создан</th>
                                    <th>Истекает</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in all_sessions %}
                                <tr
                                    class="{% if session.is_verified %}table-success{% elif session.expires_at < current_time %}table-secondary{% endif %}">
                                    <td><code>{{ session.id }}</code></td>
                                    <td>
                                        <span
                                            class="badge {% if session.is_verified %}bg-success{% elif session.expires_at > current_time %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ session.code }}
                                        </span>
                                    </td>
                                    <td>{{ session.user.username }}</td>
                                    <td>
                                        {% if session.is_verified %}
                                        <span class="badge bg-success">Использован</span>
                                        {% elif session.expires_at > current_time %}
                                        <span class="badge bg-warning">Активен</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Истек</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.created_at|date:"H:i:s" }}</td>
                                    <td>{{ session.expires_at|date:"H:i:s" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        <p>Нет сессий в базе данных</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Объяснение -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle text-primary me-2"></i>
                        Как работает сравнение кодов
                    </h6>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>Бот генерирует код</strong> → сохраняет в базу с <code>is_verified=False</code></li>
                        <li><strong>Пользователь вводит код</strong> → система ищет запись где:
                            <ul>
                                <li><code>code</code> = введенный код</li>
                                <li><code>is_verified</code> = <code>False</code></li>
                                <li><code>expires_at</code> > текущее время</li>
                            </ul>
                        </li>
                        <li><strong>Если найдена</strong> → код валидный, пользователь входит</li>
                        <li><strong>Если не найдена</strong> → код неверный или истек</li>
                    </ol>
                    <div class="alert alert-info mt-3">
                        <strong>Принцип безопасности:</strong> Только человек с доступом к Telegram-аккаунту
                        может получить код и войти в систему. Коды имеют ограниченное время жизни (1 минута).
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Настройки автообновления
    // Интервал в миллисекундах:
    const REFRESH_INTERVAL = 1000; // 1 секунда

    let autoRefreshInterval;

    async function refreshData() {
        try {
            console.log('🔄 Начинаем обновление данных...');

            // Делаем AJAX запрос для получения обновленных данных
            const response = await fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const html = await response.text();
            console.log('📥 Получены данные с сервера');

            // Создаем временный элемент для парсинга HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Обновляем статистику
            updateStatistics(tempDiv);

            // Обновляем таблицы
            updateTables(tempDiv);

            console.log('✅ Обновление данных завершено');

        } catch (error) {
            console.error('Ошибка при обновлении данных:', error);
            // В случае ошибки перезагружаем страницу
            window.location.reload();
        }
    }

    function updateStatistics(newContent) {
        // Обновляем статистику
        const newStats = newContent.querySelectorAll('.card-body h5');
        const currentStats = document.querySelectorAll('.card-body h5');

        if (newStats.length >= 2 && currentStats.length >= 2) {
            currentStats[0].textContent = newStats[0].textContent; // Активные коды
            currentStats[1].textContent = newStats[1].textContent; // Всего сессий
        }

        // Обновляем текущее время
        const newTime = newContent.querySelector('#currentTime');
        const currentTime = document.querySelector('#currentTime');
        if (newTime && currentTime) {
            currentTime.textContent = newTime.textContent;
        }
    }

    function updateTables(newContent) {
        // Обновляем всю карточку активных кодов
        const newActiveCard = newContent.querySelector('.card.mb-4 .card-body');
        const currentActiveCard = document.querySelector('.card.mb-4 .card-body');

        if (newActiveCard && currentActiveCard) {
            currentActiveCard.innerHTML = newActiveCard.innerHTML;
            console.log('✅ Обновлена таблица активных кодов');
        } else {
            console.log('❌ Не удалось найти элементы для обновления активных кодов');
        }

        // Обновляем всю карточку всех сессий (используем более точный селектор)
        const newAllCard = newContent.querySelector('.bg-info').closest('.card').querySelector('.card-body');
        const currentAllCard = document.querySelector('.bg-info').closest('.card').querySelector('.card-body');

        if (newAllCard && currentAllCard) {
            currentAllCard.innerHTML = newAllCard.innerHTML;
            console.log('✅ Обновлена таблица всех сессий');
        } else {
            console.log('❌ Не удалось найти элементы для обновления всех сессий');
            console.log('newAllCard:', newAllCard);
            console.log('currentAllCard:', currentAllCard);
        }

        // Обновляем заголовки таблиц с количеством
        const newActiveHeader = newContent.querySelector('.bg-success .mb-0');
        const currentActiveHeader = document.querySelector('.bg-success .mb-0');

        if (newActiveHeader && currentActiveHeader) {
            currentActiveHeader.innerHTML = newActiveHeader.innerHTML;
        }

        const newAllHeader = newContent.querySelector('.bg-info .mb-0');
        const currentAllHeader = document.querySelector('.bg-info .mb-0');

        if (newAllHeader && currentAllHeader) {
            currentAllHeader.innerHTML = newAllHeader.innerHTML;
        }
    }

    // Запускаем автообновление при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        // Обновляем с заданным интервалом
        autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);

        // Останавливаем автообновление при потере фокуса (пользователь переключился на другую вкладку)
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                clearInterval(autoRefreshInterval);
            } else {
                autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
            }
        });
    });

    // Останавливаем автообновление при закрытии страницы
    window.addEventListener('beforeunload', function () {
        clearInterval(autoRefreshInterval);
    });
</script>
{% endblock %}