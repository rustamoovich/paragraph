{% extends "base.html" %}
{% load static %}

{% block title %}–û—Ç–ª–∞–¥–∫–∞ –∫–æ–¥–æ–≤ ‚Äî Paragraph{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/debug_codes.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-bug text-warning me-2"></i>
                –û—Ç–ª–∞–¥–∫–∞ OTP –∫–æ–¥–æ–≤
            </h1>

            {% if error %}
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle me-2"></i>–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h5>
                <p class="mb-0"><strong>–û—à–∏–±–∫–∞:</strong> {{ error }}</p>
                <small class="text-muted">–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ MongoDB –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–∞–Ω–Ω—ã—Ö.</small>
            </div>
            {% endif %}

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4 align-items-stretch">
                <div class="col-md-3">
                    <div class="card border-success h-100">
                        <div class="card-body text-center">
                            <h5 class="text-success">{{ active_count }}</h5>
                            <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info h-100">
                        <div class="card-body text-center">
                            <h5 class="text-info">{{ total_count }}</h5>
                            <small>–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-secondary h-100">
                        <div class="card-body">
                            <small class="text-muted">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</small>
                            <div class="fw-bold" id="currentTime">{{ current_time|date:"d.m.Y H:i:s" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã ({{ active_count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if active_sessions %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ö–æ–¥</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th>–°–æ–∑–¥–∞–Ω</th>
                                    <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in active_sessions %}
                                <tr>
                                    <td><code>{{ session.id }}</code></td>
                                    <td>
                                        <span class="badge bg-primary fs-6">{{ session.code }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ session.user.username }}</strong>
                                        <br><small class="text-muted">ID: {{ session.user.id }}</small>
                                    </td>
                                    <td>{{ session.created_at|date:"H:i:s" }}</td>
                                    <td>
                                        {{ session.expires_at|date:"H:i:s" }}
                                        <br><small class="text-muted">
                                            {% if session.expires_at > current_time %}
                                            <span class="text-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                            {% else %}
                                            <span class="text-danger">–ò—Å—Ç–µ–∫</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –í—Å–µ —Å–µ—Å—Å–∏–∏ -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list me-2"></i>
                        –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ ({{ total_count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if all_sessions %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ö–æ–¥</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–°–æ–∑–¥–∞–Ω</th>
                                    <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in all_sessions %}
                                <tr
                                    class="{% if session.is_verified %}table-success{% elif session.expires_at < current_time %}table-secondary{% endif %}">
                                    <td><code>{{ session.id }}</code></td>
                                    <td>
                                        <span
                                            class="badge {% if session.is_verified %}bg-success{% elif session.expires_at > current_time %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ session.code }}
                                        </span>
                                    </td>
                                    <td>{{ session.user.username }}</td>
                                    <td>
                                        {% if session.is_verified %}
                                        <span class="badge bg-success">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>
                                        {% elif session.expires_at > current_time %}
                                        <span class="badge bg-warning">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                        {% else %}
                                        <span class="badge bg-secondary">–ò—Å—Ç–µ–∫</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.created_at|date:"H:i:s" }}</td>
                                    <td>{{ session.expires_at|date:"H:i:s" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        <p>–ù–µ—Ç —Å–µ—Å—Å–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle text-primary me-2"></i>
                        –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–¥–æ–≤
                    </h6>
                </div>
                <div class="card-body">
                    <ol>
                        <li><strong>–ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥</strong> ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±–∞–∑—É —Å <code>is_verified=False</code></li>
                        <li><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥</strong> ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –∑–∞–ø–∏—Å—å –≥–¥–µ:
                            <ul>
                                <li><code>code</code> = –≤–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥</li>
                                <li><code>is_verified</code> = <code>False</code></li>
                                <li><code>expires_at</code> > —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</li>
                            </ul>
                        </li>
                        <li><strong>–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞</strong> ‚Üí –∫–æ–¥ –≤–∞–ª–∏–¥–Ω—ã–π, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç</li>
                        <li><strong>–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</strong> ‚Üí –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫</li>
                    </ol>
                    <div class="alert alert-info mt-3">
                        <strong>–ü—Ä–∏–Ω—Ü–∏–ø –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</strong> –¢–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Telegram-–∞–∫–∫–∞—É–Ω—Ç—É
                        –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –ö–æ–¥—ã –∏–º–µ—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ (1 –º–∏–Ω—É—Ç–∞).
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö:
    const REFRESH_INTERVAL = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞

    let autoRefreshInterval;

    async function refreshData() {
        try {
            console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');

            // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const response = await fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const html = await response.text();
            console.log('üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞');

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStatistics(tempDiv);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
            updateTables(tempDiv);

            console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        }
    }

    function updateStatistics(newContent) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const newStats = newContent.querySelectorAll('.card-body h5');
        const currentStats = document.querySelectorAll('.card-body h5');

        if (newStats.length >= 2 && currentStats.length >= 2) {
            currentStats[0].textContent = newStats[0].textContent; // –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã
            currentStats[1].textContent = newStats[1].textContent; // –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        const newTime = newContent.querySelector('#currentTime');
        const currentTime = document.querySelector('#currentTime');
        if (newTime && currentTime) {
            currentTime.textContent = newTime.textContent;
        }
    }

    function updateTables(newContent) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤
        const newActiveCard = newContent.querySelector('.card.mb-4 .card-body');
        const currentActiveCard = document.querySelector('.card.mb-4 .card-body');

        if (newActiveCard && currentActiveCard) {
            currentActiveCard.innerHTML = newActiveCard.innerHTML;
            console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤');
        } else {
            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
        const newAllCard = newContent.querySelector('.bg-info').closest('.card').querySelector('.card-body');
        const currentAllCard = document.querySelector('.bg-info').closest('.card').querySelector('.card-body');

        if (newAllCard && currentAllCard) {
            currentAllCard.innerHTML = newAllCard.innerHTML;
            console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π');
        } else {
            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π');
            console.log('newAllCard:', newAllCard);
            console.log('currentAllCard:', currentAllCard);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        const newActiveHeader = newContent.querySelector('.bg-success .mb-0');
        const currentActiveHeader = document.querySelector('.bg-success .mb-0');

        if (newActiveHeader && currentActiveHeader) {
            currentActiveHeader.innerHTML = newActiveHeader.innerHTML;
        }

        const newAllHeader = newContent.querySelector('.bg-info .mb-0');
        const currentAllHeader = document.querySelector('.bg-info .mb-0');

        if (newAllHeader && currentAllHeader) {
            currentAllHeader.innerHTML = newAllHeader.innerHTML;
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
        autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É)
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                clearInterval(autoRefreshInterval);
            } else {
                autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
            }
        });
    });

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function () {
        clearInterval(autoRefreshInterval);
    });
</script>
{% endblock %}