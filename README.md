# ТЗ: Платформа генерации учебных работ на базе LLM

Версия: 1.0 (Черновик)
Дата: 25.09.2025
Обновлено: 25.09.2025
Статус: В работе (MVP)

## 1. Общие положения
- **Назначение**: описывает требования к веб‑платформе для автоматической генерации учебных работ (рефератов, курсовых, презентаций) через API языковых моделей.
- **Цель**: предоставить студентам сервис, где после заполнения формы они получают готовый файл нужного формата (DOCX/PDF/PPTX/TXT), сгенерированный и оформленный в соответствии с правилами.

## 2. Функциональные требования
### 2.1. Пользовательский интерфейс
- **Главная страница**:
  - Лендинг с описанием возможностей
  - Навигация: Типы работ, Цены, О нас, Личный кабинет
  - Квик‑старт: быстрый выбор типа работы с переходом к форме
- **Форма заказа**:
  - Тип работы: реферат, курсовая, презентация, другое
  - Поля: Тема (обяз.), Дисциплина (обяз.), Объем (стр./слайдов), Требования/пожелания (текст), Доп. параметры (стиль, структура), Срок выполнения
  - Предпросмотр стоимости в реальном времени
  - Кнопка «Сгенерировать»
- **Личный кабинет**:
  - История заказов с статусами
  - Библиотека готовых работ
  - Настройки аккаунта
  - Баланс/платежи

### 2.2. Процесс генерации
- **Workflow**: Пользователь заполняет форму → Валидация → Отправка в AI API → Поэтапная генерация → Пост‑обработка → Конвертация в формат → Скачивание/уведомление
- **Этапы**:
  - Создание плана/оглавления
  - Генерация содержания по главам
  - Введение и заключение
  - Библиография
  - Форматирование/структурирование

### 2.3. Управление контентом
- **Форматы**: DOCX, PDF, PPTX, TXT
- **Шаблоны оформления**:
  - Академический стиль, ГОСТ
  - Параметры: шрифты, интервалы, поля, нумерация, авто‑оглавление

## 3. Технические требования
### 3.1. Архитектура системы
- **Frontend**: Bootstrap (mobile‑first), минималистичный UI; возможно применение React/Next.js для SPA/SSR.
- **Backend**: Python (FastAPI предпочтительно для асинхронности; альтернатива — Django).
- **БД**: PostgreSQL
- **Кеш**: Redis
- **Очереди**: Celery (Redis/AMQP) или RQ
- **Файлы**: AWS S3/совместимое хранилище (в dev — MinIO)
- **Интеграции AI**:
  - Primary: DeepSeek API
  - Fallback: OpenAI GPT‑4o
  - Speed‑optimized: Groq API
- **Платежи**: Click, Payme
- **Аутентификация**: JWT
- **Инфраструктура**: Docker, Docker Compose; прод — Kubernetes/Helm (по необходимости), Nginx API‑шлюз

#### 3.1.1. Логическая схема
```
Client (Web) ──HTTPS──> API Gateway (Nginx)
                     └─> Backend (FastAPI)
                           ├─ PostgreSQL (users, orders, jobs, billing)
                           ├─ Redis (cache, rate limit, sessions, celery broker)
                           ├─ Celery Workers (generation pipeline)
                           ├─ AI Providers (DeepSeek / OpenAI / Groq)
                           └─ Object Storage (S3) ← generated files/artifacts
```

#### 3.1.2. Контейнеры (docker-compose)
- web (static)
- api (FastAPI)
- worker (Celery)
- redis
- postgres
- minio (dev)
- nginx

### 3.2. Процессинг генерации
- **Модуль промпт‑инжиниринга** (шаблоны с параметрами):
```python
prompt_template = {
    "type": "курсовая",
    "structure": ["введение", "теория", "анализ", "заключение"],
    "requirements": {
        "style": "академический",
        "sources": "не менее 10",
        "unique": "выше 80%"
    },
    "language": "ru",
}
```
- **Параметры AI**:
  - Temperature: 0.3–0.7 (по типу работы)
  - Max tokens: динамика по требуемому объему
  - Stop sequences: контроль структуры
- **Пайплайн**:
  1) План → 2) Главы → 3) Введение/заключение → 4) Источники → 5) Валидация/редактура → 6) Конвертация (DOCX/PDF/PPTX)
- **Пост‑обработка**:
  - Унитизация терминологии, проверка стиля
  - Сбор/верификация ссылок (по возможности)
  - Проверка уникальности (интеграция позже, optional)

### 3.3. Нефункциональные требования
- **Производительность**:
  - UI отклик < 2 c
  - Средняя генерация < 5 мин (90% < 3 мин)
  - Доступность 99.5%
- **Безопасность**:
  - JWT, шифрование PII, https везде
  - Rate limiting, DDOS защита (Cloudflare/NGINX), WAF
  - Секреты через Vault/Secrets Manager/ENV
- **Надежность**: идемпотентность задач, ретраи, дедупликация, timeouts
- **Наблюдаемость**: логирование (JSON), метрики (Prometheus), трейсы (OTel), дашборды (Grafana)

## 4. Бизнес‑логика
### 4.1. Монетизация
- **Тарифы**: pay‑per‑use (за страницу/слайд), подписка (N работ/мес), премиум (приоритет + форматы)
- **Расчет стоимости**: Базовая + (Объем × Цена) + Коэффициент срочности
- **Биллинг**: депозиты/кошелек, транзакции, статусы платежей

### 4.2. Ограничения и лимиты
- **Пользовательские**: число генераций/день, макс объем работы, стоп‑темы
- **Технические**: timeout генерации 10 мин, файл ≤ 50 MB, параллельные генерации/пользователь

## 5. UX/UI
- ≤ 3 кликов до запуска генерации
- Прогресс‑бар реального времени (этапы пайплайна)
- Уведомления: email и в UI, web‑push (optional)

## 6. API дизайн (черновик)
Базовый префикс: `/api/v1`

- `POST /auth/register` — регистрация
- `POST /auth/login` — вход, выдача JWT
- `GET /profile` — профиль пользователя
- `GET /orders` — список заказов
- `POST /orders` — создать заказ
- `GET /orders/{id}` — детали заказа и статуса
- `POST /orders/{id}/pay` — инициировать оплату (Click/Payme)
- `POST /orders/{id}/generate` — запустить генерацию (если не автозапуск)
- `GET /jobs/{id}` — статус задачи генерации
- `GET /files/{id}` — скачать результат (подписанная ссылка S3)
- `GET /pricing/quote` — расчет стоимости в реальном времени

Примеры сущностей:
```json
{
  "id": "ord_123",
  "type": "курсовая",
  "topic": "Тема...",
  "discipline": "Информатика",
  "volume": {"unit": "pages", "value": 25},
  "requirements": {"style": "академический", "gost": true},
  "deadline": "2025-10-01T12:00:00Z",
  "price": 1499.00,
  "status": "paid|processing|ready|failed",
  "job_id": "job_456"
}
```

## 7. Модель данных (черновик)
- **users**: id, email, password_hash, role, balance, created_at
- **orders**: id, user_id, type, topic, discipline, volume_value, volume_unit, requirements_json, deadline_at, price_amount, status, file_id, created_at
- **jobs**: id, order_id, stage, status, progress, attempts, error, started_at, finished_at
- **files**: id, storage_key, format, size_bytes, checksum, created_at
- **payments**: id, order_id, provider, amount, currency, status, payload_json, created_at
- **audit_logs**: id, actor_id, action, target, meta_json, created_at
- **rate_limits**: user_id, window_start, count

## 8. Очереди и пайплайн
- Очередь `generate`: задачи генерации по заказам
- Ретраи: экспоненциальная пауза, макс 3–5
- Тайм‑ауты: под‑этапы ≤ 2 мин, общий ≤ 10 мин
- Идемпотентность: ключ по `order_id`
- Чекпоинты стадий: plan → chapters → intro_outro → bibliography → postprocess → render → upload

## 9. Выбор провайдера AI
- Алгоритм:
  1) Если доступен DeepSeek и квота OK → использовать
  2) Иначе OpenAI GPT‑4o
  3) Для быстрых черновиков/черезмерной очереди → Groq
- Политики токенов, бюджет, SLA провайдеров

## 10. Формирование файлов
- DOCX: python‑docx, шаблоны стилей, авто‑оглавление
- PDF: WeasyPrint/wkhtmltopdf из HTML, либо конвертация DOCX→PDF
- PPTX: python‑pptx, шаблоны слайдов
- TXT: прямой экспорт

## 11. Качество и наблюдаемость
- Метрики: время генерации, длина очереди, % успешных, ошибки по стадиям
- Логи: сквозные `request_id`, `order_id`, `job_id`
- Трейсинг: OpenTelemetry (API→Worker→Provider)
- A/B промптов: флаги и эксперименты

## 12. Безопасность и соответствие
- PII шифрование в БД (pgcrypto/KMS)
- RBAC: роли user/admin
- Rate limiting per IP и per user
- Политики хранения: авто‑удаление исходников через N дней (конфигурируемо)
- Disclaimer об академической этике, правила использования

## 13. Платежи
- Интеграция Click, Payme: редирект/виджеты, webhook‑обработчики `/payments/webhook/{provider}`
- Статусы: pending → paid → failed/refunded
- Идемпотентность: `X-Idempotency-Key`

## 14. Планы разработки
### Phase 1: MVP (4–6 недель)
- Базовая форма заказа
- Интеграция DeepSeek
- Генерация DOCX
- Простая оплата (один провайдер)

### Phase 2: Расширение (4 недели)
- Личный кабинет
- PDF, PPTX
- Multi‑AI strategy
- Улучшенный промпт‑инжиниринг

### Phase 3: Оптимизация (3 недели)
- Кеширование результатов
- A/B тестирование промптов
- Расширенная аналитика
- Мобильное приложение (optional)

## 15. Критерии успеха
- Техметрики: 90% работ < 3 мин; качество > 4.5/5; уникальность > 75%
- Бизнес: конверсия 25%; ретеншн 40%; NPS > 30

## 16. Риски и митигация
- Технические: лимиты API (multi‑provider), качество генерации (оптимизация промптов), производительность (кеш, очереди)
- Бизнес: академическая этика (disclaimer, образовательная направленность), регуляторика (мониторинг политик), конкуренция (качество и UX)

## 17. Черновые схемы последовательностей
```
[UI] → /orders (POST) → [API] → order_id
[API] → enqueue(job) → [Queue]
[Worker] plan→chapters→intro/outro→biblio→post→render
[Worker] → upload(S3) → file_id
[API] ← webhook(payment)
[UI] ← polling /jobs/{id} | WS events
[UI] → download via signed URL
```

## 18. Дополнительно
- Локальная разработка: `docker compose up -d`
- Конфигурация: `.env` для секретов и провайдеров
- Документация API: OpenAPI/Swagger по адресу `/docs`
- Лицензии и соблюдение правил провайдеров AI
